# GoPiGo3 ROS2 드라이버 수정 내역

**날짜**: 2025-12-08
**작성자**: Claude Code

## 문제 상황

### 증상
- ROS2 드라이버가 `/cmd_vel` 토픽을 정상적으로 수신하고 모터 속도를 계산함
- 하지만 **모터가 전혀 움직이지 않음**
- 엔코더 값이 고정되어 변하지 않음

### 원인 분석
GoPiGo3 OS에서 모터가 정상 작동하는 것을 확인한 후, 예제 코드(`src/Examples/`)를 분석한 결과:

1. **예제 코드**: 공식 GoPiGo3 Python 라이브러리(`gopigo3.GoPiGo3()`)를 사용 → ✅ 작동함
2. **기존 ROS2 드라이버**: 커스텀 SPI 통신 구현(`GoPiGo3Simple` 클래스) → ❌ 작동하지 않음

**결론**: 직접 구현한 SPI 통신 코드에 문제가 있었고, 공식 라이브러리를 사용해야 함

---

## 적용한 수정사항

### 1. 공식 GoPiGo3 라이브러리 사용

**파일**: `src/gopigo3_driver/gopigo3_driver/gopigo3_driver_node.py`

#### Before (커스텀 SPI 구현)
```python
import spidev

class GoPiGo3Simple:
    """Simplified GoPiGo3 interface using direct SPI communication"""
    # ... 150줄의 커스텀 SPI 코드 ...

# 초기화
self.gpg = GoPiGo3Simple()
```

#### After (공식 라이브러리 사용)
```python
import sys
sys.path.insert(0, '/home/ubuntu/GoPiGo3/Software/Python')
import gopigo3

# 초기화
self.gpg = gopigo3.GoPiGo3()
```

### 2. 하드웨어 정보 로깅 추가
```python
# 초기화 시 하드웨어 정보 출력
manufacturer = self.gpg.get_manufacturer()
board = self.gpg.get_board()
voltage = self.gpg.get_voltage_battery()
self.get_logger().info(f'Manufacturer: {manufacturer}')
self.get_logger().info(f'Board: {board}')
self.get_logger().info(f'Battery: {voltage:.2f}V')
```

### 3. 엔코더 제로점 리셋
예제 코드 패턴을 참고하여 엔코더 오프셋 기능 추가:
```python
left_enc = self.gpg.get_motor_encoder(self.gpg.MOTOR_LEFT)
right_enc = self.gpg.get_motor_encoder(self.gpg.MOTOR_RIGHT)
self.gpg.offset_motor_encoder(self.gpg.MOTOR_LEFT, left_enc)
self.gpg.offset_motor_encoder(self.gpg.MOTOR_RIGHT, right_enc)
```

---

## 참고한 예제 코드

### 1. Motor_Encoder.py
```python
GPG.offset_motor_encoder(GPG.MOTOR_LEFT, GPG.get_motor_encoder(GPG.MOTOR_LEFT))
GPG.offset_motor_encoder(GPG.MOTOR_RIGHT, GPG.get_motor_encoder(GPG.MOTOR_RIGHT))
```
→ 엔코더 제로점 리셋 패턴

### 2. Motor_Speed.py
```python
GPG.set_motor_dps(GPG.MOTOR_RIGHT, EncoderLeft)
```
→ DPS(Degrees Per Second) 제어 방식 확인

### 3. keyboarded_robot.py
```python
self.gopigo3 = easy.EasyGoPiGo3()
self.gopigo3.forward()
self.gopigo3.backward()
```
→ 고수준 API 사용 예제 (향후 참고용)

---

## 중요한 변경사항

### ⚠️ pigpio 데몬 필요 (수정됨)
- **GoPiGo3 라이브러리 분석 결과**:
  - 초기화 시 pigpio를 사용하여 SPI 핀을 ALT0 모드로 설정
  - 실제 통신은 spidev 직접 사용 (`GPG_SPI.xfer2()`)
- **결론**: `sudo pigpiod` 실행 필수 (한 번만 실행하면 백그라운드에서 계속 실행됨)

### ✅ 의존성 단순화
- 커스텀 SPI 코드 제거 (150줄 삭제)
- `spidev` 라이브러리 의존성 제거
- 공식 GoPiGo3 라이브러리만 사용

---

## 테스트 방법

### 1. 빌드
```bash
cd ~/nav2_ws
source /opt/ros/humble/setup.zsh
colcon build --packages-select gopigo3_driver --symlink-install
source install/setup.zsh
```

### 2. pigpiod 시작
```bash
sudo pigpiod
```

### 3. 드라이버 실행
```bash
ros2 launch gopigo3_driver gopigo3_bringup.launch.py
```

**예상 출력**:
```
[gopigo3_driver]: GoPiGo3 initialized successfully
[gopigo3_driver]: Manufacturer: Dexter Industries
[gopigo3_driver]: Board: GoPiGo3
[gopigo3_driver]: Battery: 10.40V
[gopigo3_driver]: Motor encoders reset to zero
[gopigo3_driver]: Initial encoders - Left: 0, Right: 0
[gopigo3_driver]: GoPiGo3 driver node started
```

### 4. 텔레옵 테스트 (새 터미널)
```bash
source ~/nav2_ws/install/setup.zsh
ros2 run teleop_twist_keyboard teleop_twist_keyboard
```

**키 조작**:
- `i`: 전진
- `,`: 후진
- `j`: 좌회전
- `l`: 우회전
- `k`: 정지

---

## 기대 효과

1. ✅ **모터가 정상 작동**할 것으로 예상
2. ✅ **엔코더 값이 실시간으로 변화**
3. ✅ `/odom` 토픽에서 정확한 오도메트리 데이터 출력
4. ✅ RViz에서 로봇 모델이 실제 움직임과 동기화

---

## 문제 발생 시 체크리스트

### 1. GoPiGo3 라이브러리 설치 확인
```bash
ls -la /home/ubuntu/GoPiGo3/Software/Python/gopigo3.py
```

### 2. I2C 통신 확인
```bash
sudo i2cdetect -y 1
# 0x08에 GoPiGo3 보드가 보여야 함
```

### 3. 배터리 전압 확인
```bash
sudo python3
```
```python
import sys
sys.path.insert(0, '/home/ubuntu/GoPiGo3/Software/Python')
import gopigo3

GPG = gopigo3.GoPiGo3()
print("Battery:", GPG.get_voltage_battery(), "V")
# 출력: Battery: 10.4 V (정상: 9.0V 이상)
```

### 4. 권한 확인
```bash
groups ubuntu
# 출력에 i2c, spi, gpio, dialout이 포함되어야 함
```

---

## 참고 문서

- **진행 상황**: [GOPIGO3_ROS2_PROGRESS.md](GOPIGO3_ROS2_PROGRESS.md)
- **드라이버 코드**: [gopigo3_driver_node.py](src/gopigo3_driver/gopigo3_driver/gopigo3_driver_node.py)
- **Launch 파일**: [gopigo3_bringup.launch.py](src/gopigo3_driver/launch/gopigo3_bringup.launch.py)
- **예제 코드**: [src/Examples/Module_3/](src/Examples/Module_3/)
